@app.route('/register', methods=['GET','POST'])
def register():
    if request.method == 'POST':
        username = request.form['Name']
        email = request.form['email']
        password = request.form['password']
        
        cursor = mysql.connection.cursor()
        
        # Cek akun
        cursor.execute('SELECT * FROM users WHERE username=%s OR email=%s',(username, email))
        akun = cursor.fetchone()
        
        if akun is None:
            cursor.execute('INSERT INTO users (username, email, password) VALUES (%s, %s, %s)', 
                           (username, email, generate_password_hash(password)))
            mysql.connection.commit()
            flash('Registrasi Berhasil','success')
        else:
            flash('Username atau Email sudah ada','danger')

    return render_template('login.html')

    login 

    <!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
  <title>Login Page | Caged coder</title>
</head>

<body>

  <a href="{{ url_for('home') }}" class="back-button" aria-label="Kembali">
    <span class="material-symbols-outlined">arrow_back</span>
  </a>

  <div class="leaves">
    <img src="{{ url_for('static', filename='img/Daun.png') }}" class="leaf leaf1">
    <img src="{{ url_for('static', filename='img/Daun.png') }}" class="leaf leaf2">
    <img src="{{ url_for('static', filename='img/Daun.png') }}" class="leaf leaf3">
    <img src="{{ url_for('static', filename='img/Daun.png') }}" class="leaf leaf4">
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert {{ category }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}


  <div class="container" id="container">
    <div class="form-container sign-up">
      <form method="POST" action="{{ url_for('register') }}">
        <h1>Create Account</h1>
        <div class="social-icons">
          <a href="#" class="icon"><i class="fa-brands fa-google-plus-g"></i></a>
          <a href="#" class="icon"><i class="fa-brands fa-facebook-f"></i></a>
          <a href="#" class="icon"><i class="fa-brands fa-github"></i></a>
          <a href="#" class="icon"><i class="fa-brands fa-linkedin-in"></i></a>
        </div>
        <span>or use your username for registeration</span>
        <input type="text" name="Name" placeholder="Name" required>
        <input type="email" name="email" placeholder="Email" required>
        <input type="password" name="password" placeholder="Password" required>
        <button>Sign Up</button>
      </form>
    </div>

    <div class="form-container sign-in">
      <form>
        <h1>Sign In</h1>
        <div class="social-icons">
          <a href="#" class="icon"><i class="fa-brands fa-google-plus-g"></i></a>
          <a href="#" class="icon"><i class="fa-brands fa-facebook-f"></i></a>
          <a href="#" class="icon"><i class="fa-brands fa-github"></i></a>
          <a href="#" class="icon"><i class="fa-brands fa-linkedin-in"></i></a>
        </div>
        <br>
        <span>or use your username password</span>
        <input type="username" placeholder="username" />
        <input type="password" placeholder="Password" />
        <a href="#">Forget Your Password?</a>
        <button>Sign In</button>
        <div class="mobile-switch">
          <button id="mobileToggle">Register</button>
        </div>
      </form>
    </div>

    <div class="toggle-container">
      <div class="toggle">
        <div class="toggle-panel toggle-left">
          <h1>Welcome Back!</h1>
          <p>Enter your personal details to use all of site features</p>
          <button class="hidden" id="login">Sign In</button>
        </div>
        <div class="toggle-panel toggle-right">
          <h1>Hello, Friend!</h1> 
         <p>Register with your personal details to use all of site features</p>
          <button class="hidden" id="register">Sign Up</button> 
        </div>
      </div>
    </div>
  </div>


  <script src="{{ url_for('static', filename='js/script.js') }}"></script>
  <script src="{{ url_for('static', filename='js/loginmobile.js') }}"></script>
</body>

</html>



        <main class="main-content">
            {% block content %}
            {% endblock %}

            <section class="stats-cards">
                <div class="card">
                    <h3>Diagnosa Hari Ini</h3>
                    <p>45 <span class="arrow-up">â†‘</span></p>
                </div>
                <div class="card">
                    <h3>Total Penyakit</h3>
                    <p>12</p>
                </div>
                <div class="card">
                    <h3>Total Gejala</h3>
                    <p>35</p>
                </div>
            </section>

            <section class="recent-diagnoses">
                <h2>Hasil Diagnosa Terbaru</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Penyakit</th>
                            <th>Gejala</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>10-26</td>
                            <td>Busuk Akar</td>
                            <td>Daun menguning, Akar busu</td>
                            <td><span class="status-badge">Selesai</span></td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </main>


# ===================================
# CRUD DATA GEJALA
# ===================================
@app.route('/gejala')
@login_required
def admin_gejala():
    cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
    cursor.execute("SELECT * FROM tb_gejala")
    data = cursor.fetchall()
    cursor.close()

    return render_template("admin_data_gejala.html", gejala=data, active="gejala")

# --- TAMBAH GEJALA ---
@app.route('/gejala/tambah', methods=['POST'])
@login_required
def tambah_gejala():
    idg = request.form['id_gejala']
    nama = request.form['nama_gejala']

    cursor = mysql.connection.cursor()
    cursor.execute("INSERT INTO tb_gejala (id_gejala, Nama_gejala) VALUES (%s,%s)", (idg, nama))
    mysql.connection.commit()
    cursor.close()

    flash("Gejala berhasil ditambahkan!", "success")
    return redirect(url_for('admin_gejala'))


# --- EDIT GEJALA ---
@app.route('/gejala/edit', methods=['POST'])
@login_required
def edit_gejala():
    idg = request.form['id_gejala']
    nama = request.form['nama_gejala']

    cursor = mysql.connection.cursor()
    cursor.execute("UPDATE tb_gejala SET Nama_gejala=%s WHERE id_gejala=%s",
                   (nama, idg))
    mysql.connection.commit()
    cursor.close()

    flash("Gejala berhasil diperbarui!", "success")
    return redirect(url_for('admin_gejala'))

# --- HAPUS GEJALA ---
@app.route('/gejala/hapus/<id>', methods=['POST'])
@login_required
def hapus_gejala(id):
    cursor = mysql.connection.cursor()
    cursor.execute("DELETE FROM tb_gejala WHERE id_gejala=%s", (id,))
    mysql.connection.commit()
    cursor.close()

    flash("Gejala berhasil dihapus!", "success")
    return redirect(url_for('admin_gejala'))



# ===================================
# CRUD DATA PENYAKIT
# ===================================
@app.route('/penyakit')
@login_required
def admin_penyakit():
    cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
    cursor.execute("SELECT * FROM tb_penyakit")
    data = cursor.fetchall()
    cursor.close()

    return render_template("admin_data_penyakit.html", penyakit=data, active="penyakit")

# --- TAMBAH ---
@app.route('/penyakit/tambah', methods=['GET', 'POST'])
@login_required
def tambah_penyakit():
    if request.method == 'POST':
        idp = request.form['id_penyakit']
        nama = request.form['nama_penyakit']
        solusi = request.form['solusi']

        cursor = mysql.connection.cursor()
        cursor.execute("INSERT INTO tb_penyakit (id_penyakit, Nama_penyakit, solusi) VALUES (%s,%s,%s)",
                       (idp, nama, solusi))
        mysql.connection.commit()
        cursor.close()

        flash("Penyakit berhasil ditambahkan!", "success")
        return redirect(url_for('admin_penyakit'))

    return render_template("form_penyakit.html")

# --- EDIT ---
@app.route('/penyakit/edit/<id>', methods=['GET', 'POST'])
@login_required
def edit_penyakit(id):
    cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
    cursor.execute("SELECT * FROM tb_penyakit WHERE id_penyakit=%s", (id,))
    data = cursor.fetchone()

    if request.method == 'POST':
        nama = request.form['nama_penyakit']
        solusi = request.form['solusi']

        cursor2 = mysql.connection.cursor()
        cursor2.execute("""
            UPDATE tb_penyakit SET Nama_penyakit=%s, solusi=%s WHERE id_penyakit=%s
        """, (nama, solusi, id))
        mysql.connection.commit()
        cursor2.close()

        flash("Berhasil diperbarui!", "success")
        return redirect(url_for('admin_penyakit'))

    return render_template("form_penyakit_edit.html", penyakit=data)

# --- HAPUS ---
@app.route('/penyakit/hapus/<id>')
@login_required
def hapus_penyakit(id):
    cursor = mysql.connection.cursor()
    cursor.execute("DELETE FROM tb_penyakit WHERE id_penyakit=%s", (id,))
    mysql.connection.commit()
    cursor.close()

    flash("Penyakit berhasil dihapus!", "danger")
    return redirect(url_for('admin_penyakit'))

# ===================================
# CRUD RULE
# ===================================
@app.route('/rule')
@login_required
def admin_rule():
    cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
    cursor.execute("""
        SELECT r.id_rule, r.antecedents,
               p.Nama_penyakit AS penyakit
        FROM tb_rules r
        LEFT JOIN tb_penyakit p ON r.consequent_penyakit = p.id_penyakit
    """)
    data = cursor.fetchall()
    cursor.close()

    return render_template("admin_data_rule.html", rules=data, active="rule")

# --- TAMBAH RULE ---
@app.route('/rule/tambah', methods=['GET', 'POST'])
@login_required
def tambah_rule():
    cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
    cursor.execute("SELECT * FROM tb_gejala")
    gejala = cursor.fetchall()

    cursor.execute("SELECT * FROM tb_penyakit")
    penyakit = cursor.fetchall()

    if request.method == 'POST':
        idr = request.form['id_rule']
        antecedents = ",".join(request.form.getlist('gejala'))
        consequent = request.form['penyakit']

        cursor2 = mysql.connection.cursor()
        cursor2.execute("""
            INSERT INTO tb_rules (id_rule, antecedents, consequent_penyakit)
            VALUES (%s,%s,%s)
        """, (idr, antecedents, consequent))
        mysql.connection.commit()
        cursor2.close()

        flash("Rule berhasil ditambahkan!", "success")
        return redirect(url_for('admin_rule'))

    return render_template("form_rule.html", gejala=gejala, penyakit=penyakit)

# --- HAPUS RULE ---
@app.route('/rule/hapus/<id>')
@login_required
def hapus_rule(id):
    cursor = mysql.connection.cursor()
    cursor.execute("DELETE FROM tb_rules WHERE id_rule=%s", (id,))
    mysql.connection.commit()
    cursor.close()

    flash("Rule berhasil dihapus!", "danger")
    return redirect(url_for('admin_rule'))
